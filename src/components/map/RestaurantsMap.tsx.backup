'use client'

import React, { useState, useEffect, useCallback, useRef } from 'react'
import { GoogleMap, useJsApiLoader, Marker, Circle, InfoWindow } from '@react-google-maps/api'
import { Restaurant, Location } from '@/types'
import { RestaurantModal } from '@/components/RestaurantModal'
import { Button } from '@/components/ui/button'
import { MapPin, Navigation, Crosshair } from 'lucide-react'

interface RestaurantsMapProps {
  restaurants: Restaurant[]
  center: Location
  onCenterChange: (center: Location) => void
  radius: number
  onRadiusChange: (radius: number) => void
  onRestaurantSelect: (restaurant: Restaurant | null) => void
}

const mapContainerStyle = {
  width: '100%',
  height: '100%'
}

const defaultCenter = {
  lat: 52.5074,
  lng: -1.1278
}

export function RestaurantsMap({
  restaurants,
  center,
  onCenterChange,
  radius,
  onRadiusChange,
  onRestaurantSelect
}: RestaurantsMapProps) {
  const [map, setMap] = useState<google.maps.Map | null>(null)
  const [userLocation, setUserLocation] = useState<Location | null>(null)
  const [selectedRestaurant, setSelectedRestaurant] = useState<Restaurant | null>(null)
  const [infoWindow, setInfoWindow] = useState<google.maps.InfoWindow | null>(null)
  const [isDragging, setIsDragging] = useState(false)
  const lastCenterRef = useRef<Location>(center)
  const isInitializedRef = useRef(false)

  // Load Google Maps API
  const { isLoaded, loadError } = useJsApiLoader({
    id: 'google-map-script',
    googleMapsApiKey: process.env.NEXT_PUBLIC_GOOGLE_MAPS_API_KEY || '',
    libraries: ['places']
  })

  // Get user location
  const getUserLocation = useCallback(() => {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const userLoc = {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          }
          setUserLocation(userLoc)
          onCenterChange(userLoc)
        },
        (error) => {
          console.error('Error getting location:', error)
        }
      )
    }
  }, [onCenterChange])

  // Initialize map
  const onLoad = useCallback((map: google.maps.Map) => {
    setMap(map)
    
    // Create info window
    const infoWindow = new google.maps.InfoWindow()
    setInfoWindow(infoWindow)
    
    // Set initial center
    if (!isInitializedRef.current) {
      isInitializedRef.current = true
      lastCenterRef.current = center
    }
  }, [center])

  const onUnmount = useCallback(() => {
    setMap(null)
  }, [])

  // Handle restaurant marker click
  const handleMarkerClick = (restaurant: Restaurant) => {
    if (infoWindow) {
      infoWindow.setContent(`
        <div class="p-2">
          <h3 class="font-bold text-lg">${restaurant.name}</h3>
          <p class="text-gray-600">${restaurant.cuisines.join(', ')}</p>
          <p class="text-sm text-gray-500">${restaurant.address}</p>
        </div>
      `)
      infoWindow.open(map, null)
    }
    setSelectedRestaurant(restaurant)
    onRestaurantSelect(restaurant)
  }

  // Handle map drag start
  const handleDragStart = useCallback(() => {
    setIsDragging(true)
  }, [])

  // Handle map drag end
  const handleDragEnd = useCallback(() => {
    if (map && isDragging) {
      const newCenter = map.getCenter()
      if (newCenter) {
        const newCenterLocation = { lat: newCenter.lat(), lng: newCenter.lng() }
        
        // Only update if center actually changed significantly
        const latDiff = Math.abs(newCenterLocation.lat - lastCenterRef.current.lat)
        const lngDiff = Math.abs(newCenterLocation.lng - lastCenterRef.current.lng)
        
        if (latDiff > 0.001 || lngDiff > 0.001) {
          lastCenterRef.current = newCenterLocation
          onCenterChange(newCenterLocation)
        }
      }
      setIsDragging(false)
    }
  }, [map, isDragging, onCenterChange])

  // Handle radius change
  const handleRadiusChange = (newRadius: number) => {
    onRadiusChange(newRadius)
  }

  if (loadError) {
    return (
      <div className="h-full flex items-center justify-center bg-gray-100">
        <div className="text-center p-6">
          <div className="text-red-500 text-4xl mb-4">⚠️</div>
          <h3 className="text-lg font-semibold text-gray-800 mb-2">Map Loading Error</h3>
          <p className="text-gray-600 mb-4">Unable to load Google Maps</p>
          <Button onClick={() => window.location.reload()} variant="outline">
            Retry
          </Button>
        </div>
      </div>
    )
  }

  if (!isLoaded) {
    return (
      <div className="h-full flex items-center justify-center bg-gray-100">
        <div className="text-center p-6">
          <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-emerald-600 mx-auto mb-4"></div>
          <p className="text-gray-600">Loading map...</p>
        </div>
      </div>
    )
  }

  return (
    <div className="relative h-full">
      {/* Map Controls */}
      <div className="absolute top-4 left-4 z-10 space-y-2">
        <Button
          onClick={getUserLocation}
          variant="outline"
          size="sm"
          className="bg-white shadow-lg hover:bg-gray-50"
        >
          <Crosshair className="h-4 w-4 mr-2" />
          My Location
        </Button>
        
        <div className="bg-white rounded-lg shadow-lg p-3">
          <label className="block text-sm font-medium text-gray-700 mb-2">
            Search Radius: {radius}km
          </label>
          <input
            type="range"
            min="1"
            max="50"
            value={radius}
            onChange={(e) => handleRadiusChange(Number(e.target.value))}
            className="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"
          />
        </div>
      </div>

      {/* Google Map */}
      <GoogleMap
        mapContainerStyle={mapContainerStyle}
        center={center}
        zoom={12}
        onLoad={onLoad}
        onUnmount={onUnmount}
        onDragStart={handleDragStart}
        onDragEnd={handleDragEnd}
        options={{
          zoomControl: false,
          streetViewControl: false,
          mapTypeControl: false,
          fullscreenControl: false,
          styles: [
            {
              featureType: 'poi',
              elementType: 'labels',
              stylers: [{ visibility: 'off' }]
            }
          ]
        }}
      >
        {/* User Location Marker */}
        {userLocation && (
          <Marker
            position={userLocation}
            icon={{
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <circle cx="12" cy="12" r="8" fill="#3B82F6" stroke="white" stroke-width="2"/>
                  <circle cx="12" cy="12" r="3" fill="white"/>
                  <circle cx="12" cy="12" r="1" fill="#3B82F6"/>
                </svg>
              `),
              scaledSize: new google.maps.Size(24, 24),
              anchor: new google.maps.Point(12, 12)
            }}
            title="Your Location"
          />
        )}

        {/* Restaurant Markers */}
        {restaurants.map((restaurant) => (
          <Marker
            key={restaurant.id}
            position={{
              lat: (restaurant.location as any).lat || restaurant.location.latitude,
              lng: (restaurant.location as any).lng || restaurant.location.longitude
            }}
            onClick={() => handleMarkerClick(restaurant)}
            icon={{
              url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M16 2C10.48 2 6 6.48 6 12c0 7 10 18 10 18s10-11 10-18c0-5.52-4.48-10-10-10z" fill="#EF4444"/>
                  <circle cx="16" cy="12" r="4" fill="white"/>
                </svg>
              `),
              scaledSize: new google.maps.Size(32, 32),
              anchor: new google.maps.Point(16, 32)
            }}
            title={restaurant.name}
          />
        ))}

        {/* Search Radius Circle */}
        <Circle
          center={center}
          radius={radius * 1000} // Convert km to meters
          options={{
            fillColor: '#3B82F6',
            fillOpacity: 0.3,
            strokeColor: '#1D4ED8',
            strokeOpacity: 0.8,
            strokeWeight: 3
          }}
        />
      </GoogleMap>

      {/* Restaurant Modal */}
      {selectedRestaurant && (
        <RestaurantModal
          restaurant={selectedRestaurant}
          open={!!selectedRestaurant}
          onClose={() => {
            setSelectedRestaurant(null)
            onRestaurantSelect(null)
          }}
        />
      )}
    </div>
  )
}
